{% extends 'base.html' %}
{% load static %}

{% block title %}病例管理 - 眼科临床训练系统{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>病例管理</h2>
        <div>
            <a href="{% url 'teacher_case_create' %}" class="btn">创建新病例</a>
            <button class="btn secondary" onclick="document.getElementById('importModal').style.display='block'">批量导入</button>
        </div>
    </div>
    <div class="card-body">
        <!-- 搜索和筛选 -->
        <form method="get" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label>搜索病例</label>
                <input type="text" name="search" class="form-control" placeholder="输入病例名称或描述" value="{{ search }}" style="width: 300px;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>状态筛选</label>
                <select name="status" class="form-control" style="width: 150px;">
                    <option value="">全部</option>
                    <option value="active" {% if status == 'active' %}selected{% endif %}>启用</option>
                    <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>禁用</option>
                </select>
            </div>
            <button type="submit" class="btn secondary">筛选</button>
            {% if search or status %}
                <a href="{% url 'teacher_case_list' %}" class="btn secondary">清除筛选</a>
            {% endif %}
        </form>

        <!-- 病例列表 -->
        <table class="table">
            <thead>
                <tr>
                    <th>病例名称</th>
                    <th>状态</th>
                    <th>练习题数</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for case in page_obj %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            {% if case.image %}
                                <img src="{{ case.image.url }}" alt="{{ case.title }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                            {% endif %}
                            <div>
                                <strong>{{ case.title }}</strong><br>
                                <small style="color: #666;">{{ case.description|truncatewords:10 }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if case.is_active %}
                            <span style="color: #28a745; background: #d4edda; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">启用</span>
                        {% else %}
                            <span style="color: #dc3545; background: #f8d7da; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">禁用</span>
                        {% endif %}
                    </td>
                    <td>{{ case.exercises.count }}</td>
                    <td>{{ case.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        <a href="{% url 'teacher_case_edit' case.id %}" class="btn secondary" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">编辑</a>
                        <a href="{% url 'teacher_exercise_list' case.id %}" class="btn secondary" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">题目</a>
                        <button class="btn danger" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteCase({{ case.id }}, '{{ case.title }}')">删除</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                        {% if search or status %}
                            没有找到匹配的病例
                        {% else %}
                            暂无病例数据，<a href="{% url 'teacher_case_create' %}">创建第一个病例</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- 分页 -->
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page=1&search={{ search }}&status={{ status }}">&laquo; 首页</a>
                <a href="?page={{ page_obj.previous_page_number }}&search={{ search }}&status={{ status }}">上一页</a>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="current">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}&search={{ search }}&status={{ status }}">{{ num }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&search={{ search }}&status={{ status }}">下一页</a>
                <a href="?page={{ page_obj.paginator.num_pages }}&search={{ search }}&status={{ status }}">末页 &raquo;</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- 导入模态框 -->
<div id="importModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
    <div style="background: white; margin: 10% auto; padding: 20px; width: 500px; border-radius: 8px;">
        <h3 style="margin-bottom: 20px;">批量导入病例</h3>
        <form method="post" action="{% url 'import_cases' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label>选择CSV文件</label>
                <input type="file" name="csv_file" accept=".csv" class="form-control" required>
                <small style="color: #666;">CSV格式：病例名称,病例描述,症状表现,检查结果,是否启用</small>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn secondary" onclick="document.getElementById('importModal').style.display='none'">取消</button>
                <button type="submit" class="btn">导入</button>
            </div>
        </form>
    </div>
</div>

<script>
function deleteCase(caseId, caseName) {
    if (confirmDelete('确定要删除病例 "' + caseName + '" 吗？\n删除后相关的练习题目也会被删除。')) {
        fetch('/teacher/cases/' + caseId + '/delete/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('删除失败，请重试');
            }
        });
    }
}
</script>
{% endblock %}