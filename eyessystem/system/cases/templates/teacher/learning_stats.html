{% extends 'base.html' %}
{% load static %}

{% block title %}学习数据统计报告{% endblock %}

{% block extra_css %}
<style>
.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    text-align: center;
}

.metric-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    transition: transform 0.3s;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.metric-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #b71c1c;
    margin-bottom: 10px;
}

.metric-label {
    font-size: 1.1rem;
    color: #666;
    margin-bottom: 5px;
}

.metric-description {
    font-size: 0.9rem;
    color: #999;
}

.chart-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    height: 400px;
}

.top-students {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
}

.student-rank {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #eee;
}

.rank-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #b71c1c;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
}

.rank-gold { background: #ffd700; color: #333; }
.rank-silver { background: #c0c0c0; color: #333; }
.rank-bronze { background: #cd7f32; color: white; }

.student-info {
    flex-grow: 1;
}

.student-score {
    font-size: 1.2rem;
    font-weight: bold;
    color: #28a745;
}

.filter-section {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
}

.progress-bar-custom {
    height: 8px;
    border-radius: 10px;
    background: #e9ecef;
    margin: 10px 0;
}

.progress-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}

.progress-excellent { background: linear-gradient(90deg, #28a745, #20c997); }
.progress-good { background: linear-gradient(90deg, #17a2b8, #20c997); }
.progress-average { background: linear-gradient(90deg, #ffc107, #fd7e14); }
.progress-poor { background: linear-gradient(90deg, #dc3545, #e83e8c); }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="stats-card">
            <h1>学习数据统计报告</h1>
            <p>基于学生学习进度和考试记录的综合数据分析</p>
            <small>数据更新时间：{{ report_date|date:"Y年m月d日 H:i" }}</small>
        </div>
    </div>
</div>

<!-- 时间范围筛选 -->
<div class="filter-section">
    <form method="get" class="row align-items-end">
        <div class="col-md-3">
            <label>开始日期</label>
            <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
        </div>
        <div class="col-md-3">
            <label>结束日期</label>
            <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn">筛选</button>
        </div>
        <div class="col-md-2">
            <a href="{% url 'learning_stats' %}" class="btn btn-outline-secondary">重置</a>
        </div>
        <div class="col-md-2">
            <a href="{% url 'export_learning_report' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}" class="btn btn-outline-success">
                导出报告
            </a>
        </div>
    </form>
</div>

<!-- 关键指标 -->
<div class="row">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-number">{{ total_students }}</div>
            <div class="metric-label">总学生数</div>
            <div class="metric-description">系统注册学生总数</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-number">{{ active_students }}</div>
            <div class="metric-label">活跃学生</div>
            <div class="metric-description">近30天有学习记录</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-number">{{ total_exams }}</div>
            <div class="metric-label">考试总数</div>
            <div class="metric-description">已创建的考试数量</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-number">{{ avg_completion_rate|floatformat:1 }}%</div>
            <div class="metric-label">平均完成率</div>
            <div class="metric-description">学生考试参与率</div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-number">{{ avg_score|floatformat:1 }}</div>
            <div class="metric-label">平均成绩</div>
            <div class="metric-description">所有考试平均分</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-number">{{ pass_rate|floatformat:1 }}%</div>
            <div class="metric-label">总及格率</div>
            <div class="metric-description">≥60分的考试比例</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-number">{{ avg_study_time|floatformat:0 }}</div>
            <div class="metric-label">平均学习时长</div>
            <div class="metric-description">分钟/周</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-number">{{ total_cases }}</div>
            <div class="metric-label">病例总数</div>
            <div class="metric-description">系统中的病例数量</div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <div class="col-md-6">
        <div class="chart-container">
            <h5>学生成绩分布</h5>
            <canvas id="scoreDistributionChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h5>学习进度趋势</h5>
            <canvas id="progressTrendChart"></canvas>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="chart-container">
            <h5>考试类型分析</h5>
            <canvas id="examTypeChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h5>知识点掌握情况</h5>
            <canvas id="knowledgeChart"></canvas>
        </div>
    </div>
</div>

<!-- 排行榜 -->
<div class="row">
    <div class="col-md-6">
        <div class="top-students">
            <h5>学习排行榜 (按平均分)</h5>
            {% for student in top_students_by_score %}
            <div class="student-rank">
                <div class="rank-number {% if forloop.counter == 1 %}rank-gold{% elif forloop.counter == 2 %}rank-silver{% elif forloop.counter == 3 %}rank-bronze{% endif %}">
                    {{ forloop.counter }}
                </div>
                <div class="student-info">
                    <strong>{{ student.name }}</strong><br>
                    <small class="text-muted">完成 {{ student.completed_exams }} 次考试</small>
                </div>
                <div class="student-score">{{ student.avg_score|floatformat:1 }}分</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="top-students">
            <h5>活跃度排行榜 (按学习时长)</h5>
            {% for student in top_students_by_time %}
            <div class="student-rank">
                <div class="rank-number {% if forloop.counter == 1 %}rank-gold{% elif forloop.counter == 2 %}rank-silver{% elif forloop.counter == 3 %}rank-bronze{% endif %}">
                    {{ forloop.counter }}
                </div>
                <div class="student-info">
                    <strong>{{ student.name }}</strong><br>
                    <small class="text-muted">学习 {{ student.study_sessions }} 次</small>
                </div>
                <div class="student-score">{{ student.total_time|floatformat:0 }}分钟</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 知识点掌握详情 -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>各知识点掌握情况</h5>
            </div>
            <div class="card-body">
                {% for topic in knowledge_topics %}
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>{{ topic.name }}</h6>
                        <span class="badge {% if topic.mastery >= 80 %}badge-success{% elif topic.mastery >= 60 %}badge-warning{% else %}badge-danger{% endif %}">
                            {{ topic.mastery|floatformat:1 }}% 掌握
                        </span>
                    </div>
                    <div class="progress-bar-custom">
                        <div class="progress-fill {% if topic.mastery >= 80 %}progress-excellent{% elif topic.mastery >= 60 %}progress-good{% elif topic.mastery >= 40 %}progress-average{% else %}progress-poor{% endif %}" 
                             style="width: {{ topic.mastery }}%;"></div>
                    </div>
                    <small class="text-muted">
                        练习题目：{{ topic.total_exercises }} 题 | 平均正确率：{{ topic.avg_accuracy|floatformat:1 }}%
                    </small>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// 成绩分布图表
const scoreCtx = document.getElementById('scoreDistributionChart').getContext('2d');
new Chart(scoreCtx, {
    type: 'bar',
    data: {
        labels: ['0-59分', '60-69分', '70-79分', '80-89分', '90-100分'],
        datasets: [{
            label: '学生人数',
            data: {{ score_distribution }},
            backgroundColor: [
                'rgba(220, 53, 69, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(23, 162, 184, 0.8)',
                'rgba(40, 167, 69, 0.8)',
                'rgba(40, 167, 69, 0.9)'
            ],
            borderColor: [
                'rgb(220, 53, 69)',
                'rgb(255, 193, 7)',
                'rgb(23, 162, 184)',
                'rgb(40, 167, 69)',
                'rgb(40, 167, 69)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// 学习进度趋势图
const progressCtx = document.getElementById('progressTrendChart').getContext('2d');
new Chart(progressCtx, {
    type: 'line',
    data: {
        labels: {{ progress_labels|safe }},
        datasets: [{
            label: '平均分数',
            data: {{ progress_data }},
            borderColor: 'rgb(183, 28, 28)',
            backgroundColor: 'rgba(183, 28, 28, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});

// 考试类型分析
const examTypeCtx = document.getElementById('examTypeChart').getContext('2d');
new Chart(examTypeCtx, {
    type: 'doughnut',
    data: {
        labels: ['单选题', '多选题', '判断题'],
        datasets: [{
            data: {{ question_type_data }},
            backgroundColor: [
                'rgba(0, 123, 255, 0.8)',
                'rgba(40, 167, 69, 0.8)',
                'rgba(255, 193, 7, 0.8)'
            ],
            borderColor: [
                'rgb(0, 123, 255)',
                'rgb(40, 167, 69)',
                'rgb(255, 193, 7)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// 知识点掌握情况
const knowledgeCtx = document.getElementById('knowledgeChart').getContext('2d');
new Chart(knowledgeCtx, {
    type: 'radar',
    data: {
        labels: {{ knowledge_labels|safe }},
        datasets: [{
            label: '掌握程度 (%)',
            data: {{ knowledge_data }},
            borderColor: 'rgb(183, 28, 28)',
            backgroundColor: 'rgba(183, 28, 28, 0.2)',
            pointBackgroundColor: 'rgb(183, 28, 28)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(183, 28, 28)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            r: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});
</script>
{% endblock %}