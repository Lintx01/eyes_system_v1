{% extends 'base.html' %}
{% load static %}

{% block title %}{{ exam.title }} - 考试结果{% endblock %}

{% block extra_css %}
<style>
.score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    font-size: 2rem;
    font-weight: bold;
    color: white;
}

.score-excellent { background: #28a745; }
.score-good { background: #17a2b8; }
.score-average { background: #ffc107; color: #333; }
.score-poor { background: #dc3545; }

.result-summary {
    text-align: center;
    margin-bottom: 30px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #b71c1c;
}

.question-review {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.question-number {
    background: #b71c1c;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.9rem;
}

.question-status {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.9rem;
    color: white;
}

.correct { background: #28a745; }
.incorrect { background: #dc3545; }

.answer-section {
    margin: 10px 0;
    padding: 10px;
    border-radius: 4px;
}

.your-answer {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.correct-answer {
    background: #e8f5e8;
    border-left: 4px solid #4caf50;
}

.answer-incorrect {
    background: #ffebee;
    border-left: 4px solid #f44336;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body result-summary">
                <div class="score-circle {% if exam_record.score >= 90 %}score-excellent{% elif exam_record.score >= 80 %}score-good{% elif exam_record.score >= 60 %}score-average{% else %}score-poor{% endif %}">
                    {{ exam_record.score|floatformat:0 }}分
                </div>
                <h3>{{ exam.title }}</h3>
                <p class="text-muted">
                    完成时间：{{ exam_record.completed_at|date:"Y-m-d H:i:s" }}<br>
                    用时：{{ exam_record.time_spent }} 分钟
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ correct_count }}</div>
                <div>答对题数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ wrong_count }}</div>
                <div>答错题数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_count }}</div>
                <div>总题数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ accuracy|floatformat:1 }}%</div>
                <div>正确率</div>
            </div>
        </div>
    </div>
</div>

<!-- 成绩等级说明 -->
<div class="card mb-4">
    <div class="card-body">
        <h5>成绩评定</h5>
        <p>
            {% if exam_record.score >= 90 %}
                <span class="badge badge-success">优秀</span> 恭喜！您的成绩非常优秀，对眼科知识掌握得很好。
            {% elif exam_record.score >= 80 %}
                <span class="badge badge-info">良好</span> 很好！您对大部分知识点掌握得不错，继续保持。
            {% elif exam_record.score >= 60 %}
                <span class="badge badge-warning">及格</span> 您已达到及格标准，但还有提升空间，建议复习错题。
            {% else %}
                <span class="badge badge-danger">不及格</span> 需要加强学习，建议重新复习相关知识点。
            {% endif %}
        </p>
    </div>
</div>

<!-- 答题详情 -->
<div class="card">
    <div class="card-header">
        <h5>答题详情回顾</h5>
    </div>
    <div class="card-body">
        {% for answer in answers %}
        <div class="question-review">
            <div class="question-header">
                <div class="question-number">第 {{ forloop.counter }} 题</div>
                <div class="question-status {% if answer.is_correct %}correct{% else %}incorrect{% endif %}">
                    {% if answer.is_correct %}正确{% else %}错误{% endif %}
                </div>
            </div>
            
            <div class="question-text">
                <strong>{{ answer.exercise.question }}</strong>
            </div>
            
            <div class="answer-section your-answer {% if not answer.is_correct %}answer-incorrect{% endif %}">
                <strong>您的答案：</strong>
                {% if answer.exercise.question_type == 'judge' %}
                    {% if answer.user_answer == 'T' %}正确{% else %}错误{% endif %}
                {% elif answer.exercise.question_type == 'single' %}
                    {{ answer.user_answer }}. 
                    {% with answer.exercise.get_options_list as options %}
                        {% for option in options %}
                            {% if forloop.counter0|add:65|chr == answer.user_answer %}{{ option }}{% endif %}
                        {% endfor %}
                    {% endwith %}
                {% elif answer.exercise.question_type == 'multiple' %}
                    {% for char in answer.user_answer %}
                        {{ char }}.
                        {% with answer.exercise.get_options_list as options %}
                            {% for option in options %}
                                {% if forloop.counter0|add:65|chr == char %}{{ option }}{% endif %}
                            {% endfor %}
                        {% endwith %}
                        {% if not forloop.last %} | {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            
            {% if not answer.is_correct %}
            <div class="answer-section correct-answer">
                <strong>正确答案：</strong>
                {% if answer.exercise.question_type == 'judge' %}
                    {% if answer.exercise.correct_answer == 'T' %}正确{% else %}错误{% endif %}
                {% elif answer.exercise.question_type == 'single' %}
                    {{ answer.exercise.correct_answer }}. 
                    {% with answer.exercise.get_options_list as options %}
                        {% for option in options %}
                            {% if forloop.counter0|add:65|chr == answer.exercise.correct_answer %}{{ option }}{% endif %}
                        {% endfor %}
                    {% endwith %}
                {% elif answer.exercise.question_type == 'multiple' %}
                    {% for char in answer.exercise.correct_answer %}
                        {{ char }}.
                        {% with answer.exercise.get_options_list as options %}
                            {% for option in options %}
                                {% if forloop.counter0|add:65|chr == char %}{{ option }}{% endif %}
                            {% endfor %}
                        {% endwith %}
                        {% if not forloop.last %} | {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            {% endif %}
            
            {% if answer.exercise.explanation %}
            <div class="answer-section" style="background: #f8f9fa; border-left: 4px solid #6c757d;">
                <strong>题目解析：</strong>{{ answer.exercise.explanation }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        
        <div class="text-center mt-4">
            <a href="{% url 'student_exam_list' %}" class="btn">返回考试列表</a>
            <a href="{% url 'student_dashboard' %}" class="btn btn-outline-primary ml-2">返回主页</a>
        </div>
    </div>
</div>
{% endblock %}